<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../styles/style.css" media="all">
<link rel="stylesheet" href="../styles/pag-prods.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://assets.pagar.me/pagarme-js/3.0/pagarme.min.js"></script>
</head>
<style>
  div#qrCodeContainer {
    display: none;
    border: 1px solid #858383;
    position: relative;
    top: -110%;
    width: 27%;
    left: 50%;
    transform: translate(-50%);
    height: 627px;
    border-radius: 5px;
    background-color: white;
}
img#imgPix {
    position: relative;
    left: 50%;
    transform: translate(-50%);
    top: 111px;
}
button#copiarPayloadBtn {
    padding: 18px 28px 18px 28px;
    position: relative;
    top: 25%;
    left: -109px;
    transform: translate(16%);
    border: 1px solid #EF4126;
    color: #F37160;
    background-color: white;
    font-weight: bold;
    cursor: pointer;
}
h2#h2Container {
    position: relative;
    top: -36%;
    left: 50%;
    transform: translate(-50%);
}
p#expirationDateParagraph {
    position: relative;
    top: 147px;
    left: 50%;
    transform: translate(-50%);
    color: #EF4126;
}
#boletoPayContainer {
  display: none;
  border: 1px solid #858383;
  position: relative;
  top: -110%;
  width: 27%;
  left: 50%;
  transform: translate(-50%);
  height: 627px;
  border-radius: 5px;
  background-color: white;
}
h2#h2BolCont {
    position: relative;
    left: 50%;
    transform: translate(-50%);
    top: 32px;
}
a#lnkBol {
    position: relative;
    left: 2%;
    top: 17%;
}
#btnCopCodBol {
    padding: 18px 28px 18px 28px;
    border: 1px solid #EF4126;
    color: #F37160;
    background-color: white;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    top: 25%;
    left: 36%;
}
.pAcessBol {
    position: relative;
    left: 50%;
    transform: translate(-50%);
    top: 11%;
    font-weight: bold;
    color: #F37160;
}
  main > h1 {
    font-size: 30px;
    font-weight: normal;
    width: fit-content;
    position: relative;
    top: -20px;
    left: 50px;
  }
   p {
    font-size: 19px;
    font-weight: lighter;
    width: fit-content;
  }
  .container-left {
    position: relative;
    top: 30px;
    left: 10%;
    width: fit-content;
  }
  h2 {
    width: fit-content ;
  }
  .mtd-pix {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 150%;
    border-radius: 5px;
    padding: 10px;
  }
  .mtd-pix:hover {
   box-shadow: 1px 1px 6px #ef412693; 
  }
  .mtd-pix > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 80%;
    top: -50px;
    font-size: 13px;
    font-weight: bold;
  }
  .mtd-pix > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: 10%;
    top: -10px;
  }
  .mtd-pix > h2 {
    position: relative;
    left: 10%;
    top: -20px;
  }
  .mtd-pix > img {
    position: relative;
    top: 34px;
    left: 20px;
  }
  .mtd-boleto {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 150%;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
  }
  .mtd-boleto:hover {
   box-shadow: 1px 1px 6px #ef412693; 
  }
  .mtd-boleto > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 80%;
    top: -50px;
    font-size: 13px;
    font-weight: bold;
  }
  .mtd-boleto > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: 10%;
    top: -10px;
  }
  .mtd-boleto > h2 {
    position: relative;
    left: 10%;
    top: -20px;
  }
  .mtd-boleto > img {
    position: relative;
    top: 34px;
    left: 20px;
  }
  .mtd-credito {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 150%;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
  }
  .mtd-credito:hover {
   box-shadow: 1px 1px 6px #ef412693; 
  }
  .mtd-credito > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 80%;
    top: -50px;
    font-size: 13px;
    font-weight: bold;
  }
  .mtd-credito > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: 10%;
    top: -10px;
  }
  .mtd-credito > h2 {
    position: relative;
    left: 10%;
    top: -20px;
  }
  .mtd-credito > img {
    position: relative;
    top: 34px;
    left: 20px;
  }
  .container-right {
    position: relative;
    top: -64%;
    left: 75%;
    width: 25%;
    height: 25%;
  }
  .resumo-compra > h2 {
    font-weight: normal;
    font-size: 25px;
    border-bottom: 1px solid black;
    margin-bottom: 1.3rem;
  }
  .resumo-compra > p {
    font-weight: normal;
    margin-bottom: 10px;
  }
  .tot {
    border-top: 1px solid black;
    font-size: 25px;
  }
  .mtd-carteira {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 150%;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
  }
  .mtd-carteira:hover {
   box-shadow: 1px 1px 6px #ef412693; 
  }
  .mtd-carteira > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 80%;
    top: -50px;
    font-size: 13px;
    font-weight: bold;
  }
  .mtd-carteira > h2 {
    position: relative;
    left: 10%;
    top: -20px;
  }
  .mtd-carteira > img {
    position: relative;
    top: 25px;
    left: 20px;
  }
  .mtd-carteira > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: 10%;
    top: -10px;
  }
  @media screen and (min-width:1280px) and (max-width:1360px) {
    .container-right {
      position: relative;
      top: 9%;
      left: 75%;
      width: 25%;
      height: 25%;
    }
  }
  @media screen and (min-width:320px) and (max-width:481px) {
header > p {
    position: relative;
    top: 6px;
    left: 0%;
    font-size: 14px;
    letter-spacing: 0.4px;
    width: fit-content;
}
.menu2 {
    display: flex;
    list-style: none;
    width: max-content;
    position: relative;
    top: 13px;
    left: -8%;
}
.logo-imprimeai {
    position: relative;
    top: 35px;
    left: 18%;
}
main > h1 {
    font-size: 23px;
    font-weight: normal;
    width: fit-content;
    position: relative;
    top: -57px;
    left: 8px;
}
.mtd-pix {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 90vw;
    border-radius: 5px;
    padding: 10px;
}
.mtd-boleto {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 90vw;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
}
.mtd-credito {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.473);
    width: 90vw;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
}
.mtd-pix > img {
    position: relative;
    top: 1px;
    left: 72px;
}
.mtd-pix > h2 {
    position: relative;
    left: 43%;
    top: -37px;
}
.mtd-pix > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 20%;
    top: -13px;
    font-size: 13px;
    font-weight: bold;
}
.mtd-boleto > img {
    position: relative;
    top: 1px;
    left: 41px;
}
.mtd-boleto > h2 {
    position: relative;
    left: 30%;
    top: -39px;
}
.mtd-boleto > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 20%;
    top: -10px;
    font-size: 13px;
    font-weight: bold;
}
.mtd-credito > img {
    position: relative;
    top: 1px;
    left: 30px;
}
.mtd-credito > h2 {
    position: relative;
    left: 25%;
    top: -36px;
}
.mtd-credito > a {
    text-decoration: none;
    color: white;
    background-color: #EF4126;
    padding: 8px 18px 8px 18px;
    position: relative;
    left: 22%;
    top: -11px;
    font-size: 13px;
    font-weight: bold;
}
.container-right {
    position: relative;
    top: -1%;
    left: 13%;
    width: 25%;
    height: 25%;
}
.icons {
    position: relative;
    top: 24px;
    left: 0%;
    cursor: pointer;
    width: fit-content;
    padding-left: 5px;
}
.mtd-pix > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: 2%;
    top: -32px;
}
.mtd-boleto > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: -2%;
    top: -30px;
}
.mtd-credito > p {
    font-size: 14px;
    font-weight: normal;
    position: relative;
    left: -1%;
    top: -27px;
}
.container-right {
    position: relative;
    top: 5%;
    left: 13%;
    width: 25%;
    height: 25%;
}
  }
</style>
<body>
  <header>
    <div class="mini-banner">
        <!-- IMAGEM <img src="image.jpg" alt="...">-->
    </div>
    <p>Tá com pressa? <strong>ImprimeAí</strong></p>
    <nav>
        <ul class='menu2'>
            <a href="pedidos-usuario.html">Meus Pedidos</a>
            <a href="carteira.html">Minha Carteira</a>
        </ul>
        <div class="icons-header">
            <img class="icons" src="../images/facebook-icon.png" alt="...">
            <img class="icons" src="../images/youtube-icon.png" alt="...">
            <img class="icons" src="../images/instagram-icon.png" alt="...">
        </div>
    </nav>
    <div class="elem1">
       <a href="../index.html"><img class="logo-imprimeai" src="../images/logo-imprimeai2.png" alt=""></a>
        <div id="logado"></div>
        <button style="display: none;" id="sairBtn" onclick="sair()">sair</button>
    </div>
</header>
<main>
  <h1>Como você prefere pagar?</h1>
  <div class="container-left">
    <div class="metod-pag">
      <div class="mtd-pix">
        <img src="https://wbl.blob.core.windows.net/public/pix.png" alt="...">
        <h2>Pix</h2>
        <p>Aprovação em minutos. Ao finalizar sua compra disponibilizaremos o QR Code para pagamento do PIX</p>
        <a href="#" id="finalizarCompraBtn" class="finalizarCompraBtn">Finalizar a Compra</a>
      </div>
      <div class="mtd-boleto">
        <img src="https://wbl.blob.core.windows.net/public/boleto.svg" alt="...">
        <h2>Boleto Bancário</h2>
        <p>O número do boleto será gerado no final da compra</p>
        <a href="#" id="finalizarCompraBtn2" class="finalizarCompraBtn">Finalizar a Compra</a>    
      </div>
      <div class="mtd-credito">
        <img src="https://wbl.blob.core.windows.net/public/credit-card.png" alt="...">
        <h2>Cartão de Crédito</h2>
        <p>Escolha entre seus cartões de crédito ou cadastre um novo</p>
        <a href="#" id="finalizarCompraBtn3" class="finalizarCompraBtn">Finalizar a Compra</a> 
      </div>
      <div class="mtd-carteira">
        <img src="https://wbl.blob.core.windows.net/public/money.png" alt="...">
        <h2>Minha Carteira</h2>
        <p>Efetue o pagamento do seu pedido com o crédido de sua Carteira</p>
        <a href="#" id="finalizarCompraBtn4" class="finalizarCompraBtn">Finalizar a Compra</a> 
      </div>
    </div>
  </div>
  <div class="container-right">
    <div id="resumo-compra" class="resumo-compra">
      <h2>Resumo da Compra</h2>
      <p>Produtos <span id="totalItensCarrinho">0</span></p>
      <p>Frete</p>
      <p class="tot">Total <span id="totalAPagar">0.00</span></p>
    </div>
  </div>
  <div id="qrCodeContainer"></div>
  <div id="pixPayloadContainer"></div>
  <div id="boletoPayContainer"></div>
</main>
<script>
  const qrCodeContainer = document.getElementById('qrCodeContainer');
  async function carregarPerfil() {
    try {
        // Obtém o userId do cookie
        const userId = getCookie('userId');

        // Verifique se o cookie "userId" está definido
        if (!userId) {
            console.log('Usuário não autenticado');
            // Lidar com o caso de usuário não autenticado, redirecionar, exibir mensagem, etc.
            return;
        }

        // Opções da requisição, incluindo o cookie no cabeçalho
        const options = {
            headers: {
                'Cookie': `userId=${userId}`
            }
        };

        // Faça uma solicitação para a rota que retorna os dados do perfil
        const response = await fetch('/perfil/dados', options);

        // Verifique se a resposta da solicitação está OK (200)
        if (response.ok) {
            // Parse a resposta como JSON
            const data = await response.json();

            // Aqui você pode manipular os dados do perfil, por exemplo:
            console.log('Dados do perfil:', data);
            let cpfUser = data.cpfCad;
            let cepUser = data.cepCad;
            let bairroUser = data.bairroCad;
            let cidadeUser = data.cidadeCad;
            let compUser = data.compCad;
            let emailUser = data.emailCad;
            let enderecoUser = data.endereçoCad;
            let estadoUser = data.estadoCad;
            let numUser = data.numCad;
            let telefoneUser = data.telefoneCad;

        } else if (response.status === 404) {
            console.log('Usuário não encontrado');
            // Lidar com o caso de usuário não encontrado, redirecionar, exibir mensagem, etc.
        } else {
            console.error('Erro ao carregar perfil:', response.statusText);
            // Lidar com outros códigos de status de erro, exibir mensagem, etc.
        }
    } catch (error) {
        console.error('Erro ao carregar perfil:', error);
        // Lidar com erros de rede, exibir mensagem, etc.
    }
}

// Função auxiliar para obter um cookie pelo seu nome
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
  document.addEventListener('DOMContentLoaded', function () {
    const boletoPayContainer = document.getElementById('boletoPayContainer');
    carregarPerfil();
    const loadCount = parseInt(localStorage.getItem('loadCount')) || 0;
            if (loadCount < 5) {
                // Incrementa o contador de carregamento
                localStorage.setItem('loadCount', loadCount + 1);
                // Recarrega a página
                window.location.reload(true);
            } else {
                // Reseta o contador após a segunda recarga
                localStorage.removeItem('loadCount');
            }
  // Função para finalizar a compra
  function finalizarCompra() {
    // Obtenha o total de itens e o total a pagar do resumo da compra
    const totalItens = document.getElementById('totalItensCarrinho').textContent;
    const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);

    // Faça uma solicitação POST para finalizar a compra
    fetch('/finalizar-compra', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ totalItens, totalAPagar }),
    })
      .then(response => response.json())
      .then(data => {
        // Exiba uma mensagem de sucesso ou redirecione o usuário, se necessário
        alert(data.message);
        // Por exemplo, redirecione o usuário para a página de confirmação de compra
      })
      .catch(error => {
        //console.error('Erro ao finalizar a compra:', error);
        // Trate qualquer erro de finalização da compra
        //alert('Erro ao finalizar a compra');
      });
  }

});

function atualizarTotalItens() {
  const totalItensElement = document.getElementById('totalItensCarrinho');
  
  // Faça uma solicitação AJAX para obter os produtos do carrinho
  fetch('/api/carrinho')
    .then(response => response.json())
    .then(produtos => {
      // Calcule o número total de itens somando as quantidades de todos os produtos
      const numeroTotalItens = produtos.reduce((total, produto) => total + produto.quantidade, 0);
      
      // Atualize o elemento HTML com o número total de itens
      totalItensElement.textContent = numeroTotalItens;
    })
    .catch(error => {
      console.error('Erro ao atualizar o número total de itens:', error);
    });
}

// Chame a função para atualizar o número total de itens quando necessário
// Por exemplo, após adicionar ou remover um produto do carrinho
atualizarTotalItens();

function atualizarTotalAPagar() {
  const totalAPagarElement = document.getElementById('totalAPagar');

  // Faça uma solicitação AJAX para obter os produtos do carrinho
  fetch('/api/carrinho')
    .then(response => response.json())
    .then(produtos => {
      // Calcule a soma dos valores dos produtos no carrinho
      const totalAPagar = produtos.reduce((total, produto) => total + (produto.quantidade * produto.valorUnitario), 0);

      // Atualize o elemento HTML com o total a pagar formatado como moeda
      totalAPagarElement.textContent = totalAPagar.toFixed(2);
    })
    .catch(error => {
      console.error('Erro ao calcular o total a pagar:', error);
    });
}

// Chame a função para calcular e atualizar o total a pagar quando necessário
// Por exemplo, após adicionar ou remover um produto do carrinho
atualizarTotalAPagar();

async function verificarStatusPix(idPix) {
  try {
    // Inicialize o cliente Pagarme com sua chave de API
    const client = await pagarme.client.connect({ api_key: 'ak_live_Gelm3adxJjY9G3cOGcZ8bPrL1596k2' });

    // Consulte a transação PIX usando o ID do PIX
    const transaction = await client.transactions.find({ id: idPix });

    // Verifique o status da transação
    const status = transaction.status;
    
    // Retorna o status da transação PIX
    return status;
  } catch (error) {
    console.error('Erro ao verificar o status do PIX pelo Pagarme:', error);

    if (error.response && error.response.errors) {
      console.error('Detalhes do erro:', error.response.errors);
    }

    throw new Error('Erro ao verificar o status do PIX pelo Pagarme');
  }
}

// Função para verificar continuamente o status do PIX
async function monitorarStatusPix(idPix) {
  try {
    // Definir um intervalo de polling (em milissegundos)
    const pollingInterval = 5000; // 5 segundos

    while (true) {
      // Verificar o status do PIX
      const status = await verificarStatusPix(idPix);
      console.log('Status do PIX:', status);

      if (status === 'paid') {
        qrCodeContainer.style.display = 'none'
        // Se o PIX estiver pago, sair do loop de polling
        console.log('O PIX foi pago!, CRIANDO O PEDIDO');
        const totalItens = document.getElementById('totalItensCarrinho').textContent;
        const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
        const metodPag = 'Pix';

        // Crie um objeto XMLHttpRequest
        const xhr = new XMLHttpRequest();

        // Configure a solicitação POST
        xhr.open('POST', '/criar-pedidos', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        // Defina o manipulador de eventos para a resposta da solicitação
        xhr.onload = function () {
          if (xhr.status === 200) {
            // A solicitação foi bem-sucedida, você pode processar a resposta aqui
            const response = JSON.parse(xhr.responseText);
            alert(response.message);

            // Exiba a mensagem de confirmação
            document.getElementById('confirmacaoCompra').style.display = 'block';

            // Limpe o carrinho (se desejar)
            // ...

            // Atualize o resumo da compra (se desejar)
            // ...
          } else {
            // A solicitação não foi bem-sucedida, trate o erro aqui
            console.error('Erro ao finalizar a compra:', xhr.statusText);
            alert('Erro ao finalizar a compra');
          }
        };

        // Trate erros de rede
        xhr.onerror = function () {
          console.error('Erro de rede ao finalizar a compra');
          alert('Erro de rede ao finalizar a compra');
        };

        // Crie um objeto com os dados do pedido, incluindo o valor total do carrinho
        const pedidoData = {
          totalItens,
          valorPed: totalAPagar, // Atualize valorPed com o valor total do carrinho
          metodPag
        };
        console.log('PEDIDO CRIADO')
        // Envie os dados como JSON
        const requestData = JSON.stringify(pedidoData);
        xhr.send(requestData);
        break;
      }

      // Aguardar o intervalo de polling antes de fazer a próxima verificação
      await new Promise(resolve => setTimeout(resolve, pollingInterval));
    }
  } catch (error) {
    console.error('Erro ao monitorar o status do PIX:', error);
  }
}

// Evento de clique no botão "Finalizar Compra"
document.getElementById('finalizarCompraBtn').addEventListener('click', async function () {
  try {
    // Obtenha o total de itens e o total a pagar do resumo da compra
    const totalItens = document.getElementById('totalItensCarrinho').textContent;
    const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
    const valor = totalAPagar;
    const descricao = 'pedido'
    console.log(valor)

    const response = await fetch('/gerarQRPix', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ valor, descricao })
          });

if (!response.ok) {
            throw new Error('Erro ao gerar QR Code PIX');
          }
          
        const { qrDataURL, pixPayload, idPix, expirationDatePix } = await response.json();
          console.log('PIX ID:', idPix)
        // Exibir o QR Code na página
          qrCodeContainer.style.display = 'block'
          const qrCodeImg = document.createElement('img');
          qrCodeImg.src = qrDataURL;
          qrCodeImg.id = 'imgPix'
          document.getElementById('qrCodeContainer').innerHTML = '';
          document.getElementById('qrCodeContainer').appendChild(qrCodeImg);
          const copiarPayloadBtn = document.createElement('button');
          copiarPayloadBtn.id = 'copiarPayloadBtn';
          copiarPayloadBtn.innerText = 'PIX Copia e Cola';
          copiarPayloadBtn.addEventListener('click', async() => {
            // Copiar o payload PIX para a área de transferência
            await navigator.clipboard.writeText(pixPayload);
            alert('Código PIX copiado com sucesso!');

          })
          qrCodeContainer.appendChild(copiarPayloadBtn);
          
          const h2Container = document.createElement('h2');
          h2Container.innerText = 'Pagamento Pix';
          h2Container.id = 'h2Container';
          qrCodeContainer.appendChild(h2Container);

          // Exibir a data de expiração do PIX formatada
          const expirationDateFormatted = new Date(expirationDatePix).toLocaleString('pt-BR', { timeZone: 'UTC' });
          const expirationDateParagraph = document.createElement('p');
          expirationDateParagraph.id = 'expirationDateParagraph';
          expirationDateParagraph.innerText = `O PIX irá expirar em ${expirationDateFormatted}`;
          qrCodeContainer.appendChild(expirationDateParagraph);

        monitorarStatusPix(idPix);
      } catch (error) {
        console.error('Erro ao gerar o código PIX:', error);
        alert('Erro ao gerar o código PIX. Por favor, tente novamente mais tarde.');
      }
    })

    async function verificarStatusBoleto(idBoleto) {
  try {
    const client = await pagarme.client.connect({ api_key: 'ak_live_Gelm3adxJjY9G3cOGcZ8bPrL1596k2' });
    const transaction = await client.transactions.find({ id: idBoleto });
    return transaction.status;
  } catch (error) {
    console.error('Erro ao verificar o status do Boleto pelo Pagarme:', error);
    throw new Error('Erro ao verificar o status do Boleto pelo Pagarme');
  }
}
// Função para verificar continuamente o status do Boleto
async function monitorarStatusBoleto(idBoleto) {
  const boletoPayContainer = document.getElementById('boletoPayContainer');
  try {
    // Definir um intervalo de polling (em milissegundos)
    const pollingInterval = 5000; // 5 segundos

    while (true) {
      // Verificar o status do Boleto
      const status = await verificarStatusBoleto(idBoleto);
      console.log('Status do Boleto:', status);

      if (status === 'paid') {
        boletoPayContainer.style.display = 'none'
        // Se o PIX estiver pago, sair do loop de polling
        console.log('O Boleto foi pago!, CRIANDO O PEDIDO');
        const totalItens = document.getElementById('totalItensCarrinho').textContent;
        const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
        const metodPag = 'Boleto';

        // Crie um objeto XMLHttpRequest
        const xhr = new XMLHttpRequest();

        // Configure a solicitação POST
        xhr.open('POST', '/criar-pedidos', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        // Defina o manipulador de eventos para a resposta da solicitação
        xhr.onload = function () {
          if (xhr.status === 200) {
            // A solicitação foi bem-sucedida, você pode processar a resposta aqui
            const response = JSON.parse(xhr.responseText);
            alert(response.message);

            // Exiba a mensagem de confirmação
            document.getElementById('confirmacaoCompra').style.display = 'block';

            // Limpe o carrinho (se desejar)
            // ...

            // Atualize o resumo da compra (se desejar)
            // ...
          } else {
            // A solicitação não foi bem-sucedida, trate o erro aqui
            console.error('Erro ao finalizar a compra:', xhr.statusText);
            alert('Erro ao finalizar a compra');
          }
        };

        // Trate erros de rede
        xhr.onerror = function () {
          console.error('Erro de rede ao finalizar a compra');
          alert('Erro de rede ao finalizar a compra');
        };

        // Crie um objeto com os dados do pedido, incluindo o valor total do carrinho
        const pedidoData = {
          totalItens,
          valorPed: totalAPagar, // Atualize valorPed com o valor total do carrinho
          metodPag
        };
        console.log('PEDIDO CRIADO')
        // Envie os dados como JSON
        const requestData = JSON.stringify(pedidoData);
        xhr.send(requestData);
        break;
      }

      // Aguardar o intervalo de polling antes de fazer a próxima verificação
      await new Promise(resolve => setTimeout(resolve, pollingInterval));
    }
  } catch (error) {
    console.error('Erro ao monitorar o status do PIX:', error);
  }
}

    document.getElementById('finalizarCompraBtn2').addEventListener('click', async function () {
  // Obtenha o total de itens e o total a pagar do resumo da compra
  const totalItens = document.getElementById('totalItensCarrinho').textContent;
  const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
  const valor = totalAPagar;
  const metodPag = 'Boleto';
  const descricao = 'pedido'

  // Obtenha os dados do perfil do usuário
  const userId = getCookie('userId');
  if (!userId) {
    console.log('Usuário não autenticado');
    // Lidar com o caso de usuário não autenticado, redirecionar, exibir mensagem, etc.
    return;
  }

  const perfilResponse = await fetch('/perfil/dados', {
    headers: {
      'Cookie': `userId=${userId}`
    }
  });

  if (!perfilResponse.ok) {
    console.error('Erro ao obter dados do perfil:', perfilResponse.statusText);
    // Lidar com o erro ao obter dados do perfil
    return;
  }

  const perfilData = await perfilResponse.json();

  // Extrair dados do perfil
  const { userCad ,cpfCad, emailCad, telefoneCad } = perfilData;

  const nomeCliente = userCad;
  const numeroDocumento = cpfCad;
  const telefoneCliente = telefoneCad;
  const emailCliente = emailCad

  console.log(nomeCliente, numeroDocumento)

  
  const response = await fetch('/gerarBoleto', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ valor, descricao, nomeCliente, numeroDocumento })
  });
  
  if (!response.ok) {
    throw new Error('Erro ao gerar o boleto');
  }
  
  const { boletoURL, boletoExpirationDate, boletoCod, idBoleto } = await response.json();
  console.log(boletoCod)
  const boletoPayContainer = document.getElementById('boletoPayContainer');


  boletoPayContainer.style.display = 'block';
  boletoPayContainer.innerHTML = `
    <h2 id="h2BolCont">Pagamento Boleto</h2>
    <p class="pAcessBol">Acessar Boleto</p>
    <a href="${boletoURL}" target="_blank" id="lnkBol">${boletoURL}</a>
    <button id="btnCopCodBol">Copiar Código</button>
  `;

  const btnCopCodBol = document.getElementById('btnCopCodBol');
  
  btnCopCodBol.addEventListener('click', async() => {
    // Copiar o payload PIX para a área de transferência
    await navigator.clipboard.writeText(boletoCod);
    alert('Código do Boleto copiado com sucesso!');
  })
  console.log('ID DO BOLETO', idBoleto)
  monitorarStatusBoleto(idBoleto);
});

document.getElementById('finalizarCompraBtn3').addEventListener('click', function () {
  // Obtenha o total de itens e o total a pagar do resumo da compra
  const totalItens = document.getElementById('totalItensCarrinho').textContent;
  const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
  const metodPag = 'Cartão de Crédito';

  // Crie um objeto XMLHttpRequest
  const xhr = new XMLHttpRequest();

  // Configure a solicitação POST
  xhr.open('POST', '/criar-pedidos', true);
  xhr.setRequestHeader('Content-Type', 'application/json');

  // Defina o manipulador de eventos para a resposta da solicitação
  xhr.onload = function () {
    if (xhr.status === 200) {
      // A solicitação foi bem-sucedida, você pode processar a resposta aqui
      const response = JSON.parse(xhr.responseText);
      alert(response.message);

      // Exiba a mensagem de confirmação
      document.getElementById('confirmacaoCompra').style.display = 'block';

      // Limpe o carrinho (se desejar)
      // ...

      // Atualize o resumo da compra (se desejar)
      // ...
    } else {
      // A solicitação não foi bem-sucedida, trate o erro aqui
      console.error('Erro ao finalizar a compra:', xhr.statusText);
      alert('Erro ao finalizar a compra');
    }
  };

  // Trate erros de rede
  xhr.onerror = function () {
    console.error('Erro de rede ao finalizar a compra');
    alert('Erro de rede ao finalizar a compra');
  };

  // Crie um objeto com os dados do pedido, incluindo o valor total do carrinho
  const pedidoData = {
    totalItens,
    valorPed: totalAPagar, // Atualize valorPed com o valor total do carrinho
    metodPag
  };

  // Envie os dados como JSON
  const requestData = JSON.stringify(pedidoData);
  xhr.send(requestData);
});

document.getElementById('finalizarCompraBtn4').addEventListener('click', function () {
  // Obtenha o total de itens e o total a pagar do resumo da compra
  const totalItens = document.getElementById('totalItensCarrinho').textContent;
  const totalAPagar = parseFloat(document.getElementById('totalAPagar').textContent);
  const metodPag = 'Carteira Usuário';

  // Crie um objeto XMLHttpRequest
  const xhr = new XMLHttpRequest();

  // Configure a solicitação POST
  xhr.open('POST', '/criar-pedidos', true);
  xhr.setRequestHeader('Content-Type', 'application/json');

  // Defina o manipulador de eventos para a resposta da solicitação
  xhr.onload = function () {
    if (xhr.status === 200) {
      // A solicitação foi bem-sucedida, você pode processar a resposta aqui
      const response = JSON.parse(xhr.responseText);
      alert(response.message);

      // Exiba a mensagem de confirmação
      document.getElementById('confirmacaoCompra').style.display = 'block';

      // Limpe o carrinho (se desejar)
      // ...

      // Atualize o resumo da compra (se desejar)
      // ...
    } else {
      // A solicitação não foi bem-sucedida, trate o erro aqui
      console.error('Erro ao finalizar a compra:', xhr.statusText);
      alert('Erro ao finalizar a compra');
    }
  };

  // Trate erros de rede
  xhr.onerror = function () {
    console.error('Erro de rede ao finalizar a compra');
    alert('Erro de rede ao finalizar a compra');
  };

  // Crie um objeto com os dados do pedido, incluindo o valor total do carrinho
  const pedidoData = {
    totalItens,
    valorPed: totalAPagar, // Atualize valorPed com o valor total do carrinho
    metodPag
  };

  // Envie os dados como JSON
  const requestData = JSON.stringify(pedidoData);
  xhr.send(requestData);
});


</script>
</body>
</html>