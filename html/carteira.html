<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../styles/style.css" media="all">
<link rel="stylesheet" href="../styles/pag-prods.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://assets.pagar.me/pagarme-js/3.0/pagarme.min.js"></script>
</head>
<style>
    body {
        color: #212529; 
    }
    h1 {
        position: absolute;
        left: 15%;
    }
    #saldCart {
        border: 1px solid #E8E8E8;
        border-radius: 5px;
        width: 25%;
        height: 150px;
        position: relative;
        left: 15%;
        top: 100px;
        padding: 8px;
    }
    #saldCart:hover {
        transition: 1s;
        border: none;
        box-shadow: 1px 1px 6px #ef412693; 
    }
    .pVl {
        font-size: 26px;
        position: relative;
        top: 15px;
    }
    #vlrCart {
        font-size: 26px;
    }
    #saldCart > a {
        text-decoration: none;
        color: white;
        background-color: #EF4126;
        padding: 8px 18px 8px 18px;
        position: relative;
        left: 70%;
        top: -10px;
        font-size: 13px;
        font-weight: bold;
    }
    #pop-upPag {
        display: none;
        border-radius: 5px;
        border: 1px solid #858383;
        width: 25%;
        height: 900px;
        position: relative;
        left: 60%;
        transform: translate(-60%);
        top: -220px;
    }
    #fechPop {
        font-size: 22px;
        color: #212529;
        position: absolute;
        left: 90%;
        top: 1%;
    }
    #fechPop2 {
        font-size: 22px;
        color: #212529;
        position: absolute;
        left: 90%;
        top: 1%;
    }
    #pop-upPag > h2 {
        width: fit-content;
        position: relative;
        top: 20px;
        left: 20px;
    }
    #pop-upPag > ul {
        padding: 8px;
        list-style: none;
        position: relative;
        top: 50px;
    }
    #pop-upPag > ul > li {
        border-radius: 5px;
        border: 1px solid #929090;
        padding: 18px;
        font-weight: bold;
        font-size: 22px;
        margin-top: 10px;
    }
    #pop-upPag ul li.selecionado {
        transition: 1s;
        border: none;
        box-shadow: 1px 1px 6px #ef412693; 
    }
    .prossRec {
        text-decoration: none;
        color: white;
        background-color: #EF4126;
        padding: 8px 18px 8px 18px;
        position: absolute;
        left: 70%;
        top: 90%;
        font-size: 13px;
        font-weight: bold;
    }
    #pagRec {
        display: none;
        border-radius: 5px;
        border: 1px solid #858383;
        width: 25%;
        height: 600px;
        position: relative;
        left: 60%;
        transform: translate(-60%);
        top: -220px;
    }
    #pagRec > h2 {
        width: fit-content;
        position: relative;
        top: 20px;
        left: 20px;
    } 
    .vlPg {
        font-size: 26px;
        position: relative;
        top: 35px;
        left: 20px;
    }
    #vlrEsq {
        font-size: 26px;
    }
    #formaPagto {
        position: absolute;
        top: 50%;
    }
    #pagRec > h3 {
        font-weight: normal;
        position: relative;
        top: 70px;
        left: 20px;
    }
    #pagRec > a {
        color: #212529;
    }
    #mtd-Pix {
        border-bottom: 1px solid #858383;
        position: relative;
        left: 30px;
        top: 85px;
        width: 90%;
    }
    #mtd-Pix:hover {
        transition: 1s;
        border-bottom: 1px solid #EF4126;
    }
    #mtd-Pix > img {
        position: relative;
        left: 10px;
        top: 10px;
    }
    #mtd-Pix > p {
        position: relative;
        left: 60px;
        top: -25px;
    }
    #mtd-Crd {
        border-bottom: 1px solid #858383;
        position: relative;
        left: 30px;
        top: 85px;
        width: 90%;
    }
    #mtd-Crd:hover {
        transition: 1s;
        border-bottom: 1px solid #EF4126;
    }
    #mtd-Crd > img {
        position: relative;
        left: 10px;
        top: 10px;
    }
    #mtd-Crd > p {
        position: relative;
        left: 60px;
        top: -25px;
    }
    #mtd-Boleto {
        border-bottom: 1px solid #858383;
        position: relative;
        left: 30px;
        top: 85px;
        width: 90%;
    }
    #mtd-Boleto:hover {
        transition: 1s;
        border-bottom: 1px solid #EF4126;
    }
    #mtd-Boleto > img {
        position: relative;
        left: 10px;
        top: 10px;
    }
    #mtd-Boleto > p {
        position: relative;
        left: 60px;
        top: -25px;
    }
    div#qrCodeContainer {
        display: none;
        border: 1px solid #858383;
        position: relative;
        top: -27%;
        width: 27%;
        left: 57%;
        transform: translate(-50%);
        height: 627px;
        border-radius: 5px;
        background-color: white;
    }
        img#imgPix {
        position: relative;
        left: 50%;
        transform: translate(-50%);
        top: 111px;
    }
    button#copiarPayloadBtn {
        padding: 18px 28px 18px 28px;
        position: relative;
        top: 25%;
        left: -109px;
        transform: translate(16%);
        border: 1px solid #EF4126;
        color: #F37160;
        background-color: white;
        font-weight: bold;
        cursor: pointer;
    }
    h2#h2Container {
        position: relative;
        top: -36%;
        left: 31%;
    }
    p#expirationDateParagraph {
        position: relative;
        top: 147px;
        left: 68%;
        transform: translate(-50%);
        color: #EF4126;
    }
    #boletoPayContainer {
        display: none;
        border: 1px solid #858383;
        position: relative;
        top: -27%;
        width: 27%;
        left: 57%;
        transform: translate(-50%);
        height: 627px;
        border-radius: 5px;
        background-color: white;
    }
    h2#h2BolCont {
        position: relative;
        left: 80%;
        transform: translate(-50%);
        top: 32px;
    }
    a#lnkBol {
        position: relative;
        left: 2%;
        top: 17%;
    }
    #btnCopCodBol {
        padding: 18px 28px 18px 28px;
        border: 1px solid #EF4126;
        color: #F37160;
        background-color: white;
        font-weight: bold;
        cursor: pointer;
        position: relative;
        top: 25%;
        left: 39%;
    }
    .pAcessBol {
        position: relative;
        left: 91%;
        transform: translate(-50%);
        top: 11%;
        font-weight: bold;
        color: #F37160;
    }
    </style>
<body>
    <header>
        <div class="mini-banner">
            <!-- IMAGEM <img src="image.jpg" alt="...">-->
        </div>
        <p>Tá com pressa? <strong>ImprimeAí</strong></p>
        <nav>
            <ul class='menu2'>
                <a href="pedidos-usuario.html">Meus Pedidos</a>
                <a href="carteira.html">Minha Carteira</a>
            </ul>
            <div class="icons-header">
                <img class="icons" src="../images/facebook-icon.png" alt="...">
                <img class="icons" src="../images/youtube-icon.png" alt="...">
                <img class="icons" src="../images/instagram-icon.png" alt="...">
            </div>
        </nav>
        <div class="elem1">
           <a href="../index.html"><img class="logo-imprimeai" src="../images/logo-imprimeai2.png" alt=""></a>
        </div>
    </header>
    <main>
        <h1>Minha Carteira</h1>
        <div id="saldCart">
            <h2>Saldo da Carteira:</h2>
            <p class="pVl">R$ <span id="vlrCart">0,00</span></p>
            <a href="#" id="btnRec">Recarregar</a>
        </div>
        <div id="pop-upPag">
            <a href="#" id="fechPop">X</a>
            <h2>Escolha um Valor</h2>
            <ul>
                <li>R$ 30,00</li>
                <li>R$ 50,00</li>
                <li>R$ 100,00</li>
                <li>R$ 150,00</li>
                <li>R$ 200,00</li>
                <li>R$ 300,00</li>
                <li>R$ 400,00</li>
            </ul>
            <a href="#" class="prossRec" id="prossRec">Continuar</a>
        </div>
        <div id="pagRec">
            <a href="#" id="fechPop2">X</a>
            <h3>Escolha a forma de Pagamento</h3>
            <a href="#" id="btnPix">
                <div id="mtd-Pix">
                    <img src="https://wbl.blob.core.windows.net/public/pix.png" alt="...">
                    <p>Pix</p>
                </div>
            </a>
            <a href="#">
                <div id="mtd-Crd">
                    <img src="https://wbl.blob.core.windows.net/public/credit-card.png" alt="...">
                    <p>Cartão de Crédito</p>
                </div>
            </a>
            <a href="#" id="btnBol">
                <div id="mtd-Boleto">
                    <img src="https://wbl.blob.core.windows.net/public/boleto.svg" alt="...">
                    <p>Boleto Bancário</p>
                </div>
            </a>
        </div>
        <div id="qrCodeContainer"></div>
        <div id="boletoPayContainer"></div>
    </main>
    <script>
        const btnRec = document.getElementById('btnRec');
        const popupPag = document.getElementById('pop-upPag');
        const pagRec = document.getElementById('pagRec');
        const btnProssRec = document.getElementById('prossRec');
        const btnFechPop = document.getElementById('fechPop');
        const btnFechPop2 = document.getElementById('fechPop2');
        const vlrEsq = document.getElementById('vlrEsq');
        const btnPix = document.getElementById('btnPix');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const btnBol = document.getElementById('btnBol');
        const boletoPayContainer = document.getElementById('boletoPayContainer');
       btnRec.addEventListener('click', () => {
        popupPag.style.display = 'block'
       })
       btnFechPop.addEventListener('click', () => {
        popupPag.style.display = 'none'
        pagRec.style.display = 'none'
       })
       btnFechPop2.addEventListener('click', () => {
        popupPag.style.display = 'none'
        pagRec.style.display = 'none'
       })
       btnProssRec.addEventListener('click', () => {
        popupPag.style.display = 'none'
        pagRec.style.display = 'block'
       })
       
       function getCookie(name) {
           const value = `; ${document.cookie}`;
           const parts = value.split(`; ${name}=`);
           if (parts.length === 2) return parts.pop().split(';').shift();
        };
        let userId = getCookie('userId');

        
        const valores = document.querySelectorAll('#pop-upPag ul li');
        let valorSelecionado = 0;
        
        valores.forEach(valor => {
            valor.addEventListener('click', () => {
                // Remover a classe 'selecionado' de todos os valores
                valores.forEach(item => {
                    item.classList.remove('selecionado');
                });
                
                // Adicionar a classe 'selecionado' apenas ao valor clicado
                valor.classList.add('selecionado');
                
                // Armazenar o valor selecionado na variável
                valorSelecionado = parseFloat(valor.textContent.replace('R$ ', ''));
                console.log('Valor selecionado:', valorSelecionado);
            });
        });

        btnProssRec.addEventListener('click', () => {
            console.log('Continuar com o valor:', valorSelecionado);
            // Aqui você pode prosseguir com o valor selecionado, como enviar para o servidor ou realizar alguma operação com ele.
        });

        async function verificarStatusPix(idPix) {
            try {
                // Inicialize o cliente Pagarme com sua chave de API
                const client = await pagarme.client.connect({ api_key: 'ak_live_Gelm3adxJjY9G3cOGcZ8bPrL1596k2' });

                // Consulte a transação PIX usando o ID do PIX
                const transaction = await client.transactions.find({ id: idPix });

                // Verifique o status da transação
                const status = transaction.status;
                
                // Retorna o status da transação PIX
                return status;
            } catch (error) {
                console.error('Erro ao verificar o status do PIX pelo Pagarme:', error);
                
                if (error.response && error.response.errors) {
                    console.error('Detalhes do erro:', error.response.errors);
                }
                
                throw new Error('Erro ao verificar o status do PIX pelo Pagarme');
            }
            }

            // Função para verificar continuamente o status do PIX
            async function monitorarStatusPix(idPix) {
                try {
                    // Definir um intervalo de polling (em milissegundos)
                    const pollingInterval = 5000; // 5 segundos
                    
                while (true) {
                    // Verificar o status do PIX
                const status = await verificarStatusPix(idPix);
                console.log('Status do PIX:', status);

                if (status === 'paid') {
                    qrCodeContainer.style.display = 'none'
                    // Se o PIX estiver pago, sair do loop de polling
                    console.log('O PIX foi pago!, DEPOSITANDO NA CARTEIRA');
                    const metodPag = 'Pix';
                    
                    const detalhesPagamento = {
                        userId: userId,
                        valor: valorSelecionado,
                        metodoPagamento: metodPag,
                        status: "PAGO"
                    };
                    
                    try {
                        const response = await fetch('/registrarPagamento', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(detalhesPagamento)
                        });
                        
                        if (!response.ok) {
                            throw new Error('Erro ao registrar o pagamento');
                        }
                        
                        console.log('Pagamento registrado com sucesso!');
                    } catch (error) {
                        console.error('Erro ao registrar o pagamento:', error);
                    }
                        break;
                }
                
                // Aguardar o intervalo de polling antes de fazer a próxima verificação
                await new Promise(resolve => setTimeout(resolve, pollingInterval));
                }
            } catch (error) {
                console.error('Erro ao monitorar o status do PIX:', error);
            }
        }

            btnPix.addEventListener('click', async () => {
                const valor = valorSelecionado;
                const descricao = "Depósito Carteira";
                const metodPag = "Pix";
                
                
                try {
                    const response = await fetch('/gerarQRPix', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ valor, descricao })
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao gerar QR Code PIX');
                    }

                    const { qrDataURL, pixPayload, idPix, expirationDatePix } = await response.json();
                    
                    qrCodeContainer.style.display = 'block'
                    pagRec.style.display = 'none'
                    const qrCodeImg = document.createElement('img');
                    qrCodeImg.src = qrDataURL;
                    qrCodeImg.id = 'imgPix'
                    document.getElementById('qrCodeContainer').innerHTML = '';
                    document.getElementById('qrCodeContainer').appendChild(qrCodeImg);
                    const copiarPayloadBtn = document.createElement('button');
                    copiarPayloadBtn.id = 'copiarPayloadBtn';
                    copiarPayloadBtn.innerText = 'PIX Copia e Cola';
                    copiarPayloadBtn.addEventListener('click', async() => {
                        // Copiar o payload PIX para a área de transferência
                        await navigator.clipboard.writeText(pixPayload);
                        alert('Código PIX copiado com sucesso!');
                        
                    })
                    qrCodeContainer.appendChild(copiarPayloadBtn);
            
                    const h2Container = document.createElement('h2');
                    h2Container.innerText = 'Pagamento Pix';
                    h2Container.id = 'h2Container';
                    qrCodeContainer.appendChild(h2Container);
                    
                    // Exibir a data de expiração do PIX formatada
                    const expirationDateFormatted = new Date(expirationDatePix).toLocaleString('pt-BR', { timeZone: 'UTC' });
                    const expirationDateParagraph = document.createElement('p');
                    expirationDateParagraph.id = 'expirationDateParagraph';
                    expirationDateParagraph.innerText = `O PIX irá expirar em ${expirationDateFormatted}`;
                    qrCodeContainer.appendChild(expirationDateParagraph);
                    monitorarStatusPix(idPix);
                    
                } catch (error) {
                    console.error('Erro:', error);
                }
            });

            async function verificarStatusBoleto(idBoleto) {
                try {
                    const client = await pagarme.client.connect({ api_key: 'ak_live_Gelm3adxJjY9G3cOGcZ8bPrL1596k2' });
                    const transaction = await client.transactions.find({ id: idBoleto });
                    return transaction.status;
                } catch (error) {
                    console.error('Erro ao verificar o status do Boleto pelo Pagarme:', error);
                    throw new Error('Erro ao verificar o status do Boleto pelo Pagarme');
                }
                }
                // Função para verificar continuamente o status do Boleto
                async function monitorarStatusBoleto(idBoleto) {
                    const boletoPayContainer = document.getElementById('boletoPayContainer');
                    try {
                        // Definir um intervalo de polling (em milissegundos)
                        const pollingInterval = 5000; // 5 segundos

                        // Defina um limite de tempo em milissegundos (15 segundos)
                        const limiteTempo = 15000; // 15 segundos

                        // Defina o horário inicial
                        const horarioInicial = Date.now();

                        while (true) {
                            // Verificar o status do Boleto
                            const status = await verificarStatusBoleto(idBoleto);
                            console.log('Status do Boleto:', status);

                            // Verifica se o tempo limite foi atingido
                            if (Date.now() - horarioInicial > limiteTempo) {
                                console.log('Tempo limite atingido. Criando o pedido mesmo sem o pagamento confirmado.');
                                const metodPag = "BOLETO";
                                const detalhesPagamento = {
                                    userId: userId,
                                    valor: valorSelecionado,
                                    metodoPagamento: metodPag,
                                    status: "ESPERANDO PAGAMENTO",
                                    idTransacao: idBoleto,
                                };

                                try {
                                    // Registre o pagamento
                                    const response = await fetch('/registrarPagamento', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(detalhesPagamento)
                                    });
                                    
                                    if (!response.ok) {
                                        throw new Error('Erro ao registrar o pagamento');
                                    }
                                    
                                    console.log('Pagamento registrado com sucesso!');
                                    boletoPayContainer.style.display = 'none'
                                } catch (error) {
                                    console.error('Erro ao registrar o pagamento:', error);
                                }
                                break;
                            }

                            // Aguardar o intervalo de polling antes de fazer a próxima verificação
                            await new Promise(resolve => setTimeout(resolve, pollingInterval));
                        }
                    } catch (error) {
                        console.error('Erro ao monitorar o status do Boleto:', error);
                    }
                }
        
            btnBol.addEventListener('click', async () => {
                const valor = valorSelecionado;
                const metodPag = "Boleto";
                const descricao = "DEPÓSITO CARTEIRA"

                if (!userId) {
                    console.log('Usuário não autenticado');
                    // Lidar com o caso de usuário não autenticado, redirecionar, exibir mensagem, etc.
                    return;
                }
                
                const perfilResponse = await fetch('/perfil/dados', {
                    headers: {
                        'Cookie': `userId=${userId}`
                    }
                });
            
                if (!perfilResponse.ok) {
                    console.error('Erro ao obter dados do perfil:', perfilResponse.statusText);
                    // Lidar com o erro ao obter dados do perfil
                    return;
                }
                
                const perfilData = await perfilResponse.json();
                
                // Extrair dados do perfil
                const { userCad ,cpfCad, emailCad, telefoneCad } = perfilData;
                
                const nomeCliente = userCad;
                const numeroDocumento = cpfCad;
                const telefoneCliente = telefoneCad;
                const emailCliente = emailCad
                console.log(nomeCliente, numeroDocumento)
            
            
                const response = await fetch('/gerarBoleto', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ valor, descricao, nomeCliente, numeroDocumento })
                });

                if (!response.ok) {
                    throw new Error('Erro ao gerar o boleto');
                }
                
                const { boletoURL, boletoExpirationDate, boletoCod, idBoleto } = await response.json();
                console.log(boletoCod)
                const boletoPayContainer = document.getElementById('boletoPayContainer');


                boletoPayContainer.style.display = 'block';
                pagRec.style.display = 'none'
                boletoPayContainer.innerHTML = `
                <h2 id="h2BolCont">Pagamento Boleto</h2>
                <p class="pAcessBol">Acessar Boleto</p>
                <a href="${boletoURL}" target="_blank" id="lnkBol">${boletoURL}</a>
                <button id="btnCopCodBol">Copiar Código</button>
                `;

                const btnCopCodBol = document.getElementById('btnCopCodBol');

                btnCopCodBol.addEventListener('click', async() => {
                    // Copiar o payload PIX para a área de transferência
                    await navigator.clipboard.writeText(boletoCod);
                    alert('Código do Boleto copiado com sucesso!');
                })
                console.log('ID DO BOLETO', idBoleto)
                monitorarStatusBoleto(idBoleto);
            })

        // Solicitação AJAX para buscar e exibir o saldo do usuário na página HTML
        async function exibirSaldoUsuario() {
            try {
                const response = await fetch('/saldoUsuario');
                const data = await response.json();
                const saldoFormatado = formatarSaldo(data.saldo); // Formate o saldo se necessário

                // Atualize o elemento HTML com o saldo do usuário
                document.getElementById('vlrCart').textContent = saldoFormatado;
            } catch (error) {
                console.error('Erro ao buscar saldo do usuário:', error);
            }
        }

        // Função para formatar o saldo (adicione R$ e formate para duas casas decimais)
        function formatarSaldo(saldo) {
            return `${saldo.toFixed(2)}`;
        }
 
        // Chame a função para exibir o saldo do usuário quando a página for carregada
        exibirSaldoUsuario();

    </script>
</body>
</html>